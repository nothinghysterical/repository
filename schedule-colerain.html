<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Room Assignments by Housekeeper</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      text-align: center;
    }
    .housekeeper-section {
      margin-bottom: 40px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 20px;
    }
    .day {
      margin-left: 20px;
    }
    ul {
      list-style-type: disc;
      margin-left: 40px;
    }
  </style>
</head>
<body>
  <h2>Pending Room Assignments</h2>
  <div id="schedule-container"></div>

  <script>
    const apiKey = 'YOUR_JOTFORM_API_KEY';
    const formId = 'YOUR_FORM_ID';
    const roomFieldId = '18'; // Replace with actual field ID

    function getWeekBounds() {
      const now = new Date();
      const day = now.getDay();
      const diffToMonday = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setHours(0, 0, 0, 0);
      monday.setDate(now.getDate() + diffToMonday);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { monday, sunday };
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split('\t');
      return lines.slice(1).map(line => {
        const values = line.split('\t');
        const obj = {};
        headers.forEach((header, index) => {
          obj[header.trim()] = values[index] ? values[index].trim() : '';
        });
        return obj;
      });
    }

    async function loadSchedule() {
      const { monday, sunday } = getWeekBounds();

      const [scheduleText, assigneesText] = await Promise.all([
        fetch('Colerain - Special Schedule.csv').then(res => res.text()),
        fetch('Colerain Assignees.csv').then(res => res.text())
      ]);
      const schedule = parseCSV(scheduleText);
      const assignees = parseCSV(assigneesText);

      // Build a map from housekeeper letter to name
      const nameMap = {};
      assignees.forEach(a => {
        nameMap[a['Housekeeper']] = a['Name'];
      });

      // Fetch completed submissions
      const submissions = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&limit=1000`)
        .then(res => res.json())
        .then(data => data.content || []);

      const completedRooms = new Set();
      submissions.forEach(sub => {
        const createdAt = new Date(sub.created_at);
        if (createdAt >= monday && createdAt <= sunday) {
          const room = sub.answers?.[roomFieldId]?.answer?.trim();
          if (room) completedRooms.add(room);
        }
      });

      const pendingTasks = schedule.filter(task => !completedRooms.has(task['Room Name']));

      // Group by Housekeeper → Day → Room Name
      const grouped = {};
      pendingTasks.forEach(task => {
        const hk = task['Housekeeper'];
        const name = nameMap[hk] || `Housekeeper ${hk}`;
        const day = task['Day'];
        const room = task['Room Name'];

        if (!grouped[name]) grouped[name] = {};
        if (!grouped[name][day]) grouped[name][day] = [];
        grouped[name][day].push(room);
      });

      // Render
      const container = document.getElementById('schedule-container');
      container.innerHTML = '';

      Object.keys(grouped).forEach(name => {
        const hkSection = document.createElement('div');
        hkSection.className = 'housekeeper-section';

        const hkHeader = document.createElement('h3');
        hkHeader.textContent = name;
        hkSection.appendChild(hkHeader);

        Object.keys(grouped[name]).forEach(day => {
          const dayHeader = document.createElement('h4');
          dayHeader.className = 'day';
          dayHeader.textContent = day;
          hkSection.appendChild(dayHeader);

          const list = document.createElement('ul');
          grouped[name][day].forEach(room => {
            const li = document.createElement('li');
            li.textContent = room;
            list.appendChild(li);
          });

          hkSection.appendChild(list);
        });

        container.appendChild(hkSection);
      });
    }

    loadSchedule().catch(err => {
      console.error('Error loading data:', err);
    });
  </script>
</body>
</html>
