async function load() {
  const assignmentsDiv = document.getElementById('assignments');

  const scheduleResponse = await fetch('Colerain - Special Schedule.csv');
  const scheduleText = await scheduleResponse.text();
  const scheduleData = parseCsv(scheduleText);

  const apiKey = '5b9a10e2092947d49dac84004ad149a2';
  const formId = '250955404825056';
  const roomFieldId = '18';

  const submissionsData = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&limit=1000`)
    .then(res => res.json())
    .then(json => json.content || []);

  const monday = getMonday();
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);

  // Build a map of room -> latest submission date
  const completedRoomsMap = {};
  submissionsData.forEach(sub => {
    const createdAt = new Date(sub.created_at);
    if (createdAt < monday || createdAt > sunday) return;

    const room = sub.answers?.[roomFieldId]?.answer?.trim();
    if (room) {
      if (!completedRoomsMap[room] || new Date(completedRoomsMap[room]) < createdAt) {
        completedRoomsMap[room] = createdAt.toLocaleString();
      }
    }
  });

  // Group all assignments
  const grouped = {};
  function getName(initial) {
    return housekeeperNames[initial] || initial;
  }

  for (const item of scheduleData) {
    const day = item.Day;
    const hkInitial = item.Housekeeper;
    const room = item['Room Name'];
    if (!day || !hkInitial || !room) continue;

    const hkName = getName(hkInitial);
    if (!grouped[hkName]) grouped[hkName] = {};
    if (!grouped[hkName][day]) grouped[hkName][day] = [];
    grouped[hkName][day].push(room);
  }

  // Prepare display
  const housekeepersWithRooms = Object.entries(grouped)
    .map(([hkName, days]) => {
      const filteredDays = {};
      weekdayOrder.forEach(day => {
        if (days[day]?.length) {
          filteredDays[day] = days[day];
        }
      });
      return [hkName, filteredDays];
    })
    .filter(([_, days]) => Object.keys(days).length > 0);

  if (housekeepersWithRooms.length === 0) {
    assignmentsDiv.innerHTML = `<p class="no-pending">All rooms are completed this week!</p>`;
    return;
  }

  let html = '';
  housekeepersWithRooms.forEach(([hkName, days]) => {
    html += `<h2>${hkName}</h2>`;
    for (const day of Object.keys(days)) {
      html += `<h3>${day}</h3><ul>`;
      days[day].forEach(room => {
        const submittedTime = completedRoomsMap[room];
        const completed = submittedTime ? ` <span class="completed">(Completed: ${submittedTime})</span>` : '';
        const roomClass = submittedTime ? 'completed' : '';
        html += `<li class="${roomClass}">${room}${completed}</li>`;
      });
      html += `</ul>`;
    }
  });

  assignmentsDiv.innerHTML = html;
}
