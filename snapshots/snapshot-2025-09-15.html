<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pending Room Assignments</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 1rem; }
    h2 { margin-top: 2rem; margin-bottom: 0.5rem; }
    h3 { margin-left: 1rem; margin-bottom: 0.25rem; color: #333; }
    ul { margin-left: 2rem; margin-bottom: 1rem; list-style-type: none; padding-left: 1rem; }
    li { margin-bottom: 0.25rem; }

    .completed { color: green; }
    .completed::before {
      content: "✓ ";
      color: green;
      font-weight: bold;
      margin-right: 0.25rem;
    }

    .returned {
      color: orange;
      font-weight: bold;
    }
    .returned::before {
      content: "↺ ";
      color: orange;
      font-weight: bold;
      margin-right: 0.25rem;
    }

    .pending { font-weight: bold; }

    .no-pending { text-align: center; color: #666; margin-top: 2rem; font-style: italic; }
    .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; margin-bottom: 1rem; }
    .progress-fill { height: 20px; background-color: #4caf50; width: 0%; transition: width 0.5s; text-align: center; color: white; line-height: 20px; }
    .refresh-button { display: inline-block; margin: 0 auto 1rem; padding: 0.5rem 1rem; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .schedule-name { text-align: center; margin-top: 2rem; color: #666; }
  </style>
</head>
<body>
  <h1>Pending Room Assignments</h1>
  <button class="refresh-button" onclick="location.reload()">Refresh</button>
  <div class="progress-bar"><div id="progress" class="progress-fill" style="width: 35%;">35%</div></div>
  <div id="assignments"><h2>Thomas (32 remaining)</h2><h3>Any</h3><ul><li class="pending"><a href="https://form.jotform.com/250955404825056?space=Clean Outside Windows-Courtyard-Zone-A" target="_blank" rel="noopener noreferrer">Clean Outside Windows-Courtyard-Zone-A</a></li></ul><h3>Monday</h3><ul><li class="completed">72 Building Trash - 9/15/2025, 8:56:15 AM</li><li class="pending">25/52 Building Trash</li><li class="completed">Room 320 - 9/15/2025, 10:21:59 AM</li><li class="completed">Room 323 - 9/15/2025, 10:27:35 AM</li><li class="completed">Room 326 - 9/15/2025, 10:36:15 AM</li><li class="completed">Room 328 - 9/15/2025, 10:16:20 AM</li><li class="completed">Room 330 - 9/15/2025, 11:00:03 AM</li><li class="completed">Janitorial 72-3 - 9/15/2025, 10:43:37 AM</li><li class="completed">Bathroom 72-3-1 - 9/15/2025, 10:04:05 AM</li><li class="completed">Bathroom 72-3-2 - 9/15/2025, 10:05:40 AM</li><li class="pending">Entrance A Stairs</li><li class="pending">Entrance A</li></ul><h3>Tuesday</h3><ul><li class="pending">Room 220</li><li class="pending">Kitchen 72-2</li><li class="pending">Hallway 72-2</li><li class="pending">Janitorial 72-2</li><li class="pending">Bathroom 72-2-1</li><li class="pending">Bathroom 72-2-2</li><li class="pending">The Zone</li><li class="pending">Bathroom Zone</li></ul><h3>Wednesday</h3><ul><li class="pending">Hallway 72-1</li><li class="pending">Room 124</li><li class="pending">Room 127</li><li class="pending">Janitorial 72-1</li><li class="pending">Bathroom 72-1-1</li><li class="pending">Bathroom 72-1-2</li><li class="pending">Bathroom 127</li><li class="pending">Stairwell F</li><li class="pending">Entrance F</li></ul><h3>Thursday</h3><ul><li class="pending">Bathroom 25-2-1</li><li class="pending">Bathroom 25-2-2</li><li class="pending">Gym (Lower)</li><li class="pending">Gym (Upper)</li></ul><h3>Friday</h3><ul><li class="pending">Room Office</li><li class="pending">Room Conference</li><li class="pending">Kitchen Office</li><li class="pending">Room Meet 1</li><li class="pending">Room Meet 2</li><li class="pending">Room Meet 3</li><li class="pending">Hallway 25-1</li></ul><h2>Garrett (18 remaining)</h2><h3>Any</h3><ul><li class="pending"><a href="https://form.jotform.com/250955404825056?space=Cut Back Ground Cover by Chiller" target="_blank" rel="noopener noreferrer">Cut Back Ground Cover by Chiller</a></li></ul><h3>Monday</h3><ul><li class="pending">92 Building Trash</li><li class="pending">Hallway FH1</li><li class="pending">Hallway FH2</li><li class="pending">Room 108-110</li><li class="completed">Room 113 - 9/15/2025, 2:41:44 PM</li><li class="completed">Room 112 - 9/15/2025, 2:41:50 PM</li><li class="completed">Room 111 - 9/15/2025, 2:41:59 PM</li><li class="completed">Kitchen 92-1 - 9/15/2025, 1:11:51 PM</li><li class="pending">Janitorial 92-1</li><li class="completed">Room 102 - 9/15/2025, 1:27:42 PM</li><li class="completed">Room 103 - 9/15/2025, 1:27:29 PM</li><li class="completed">Bathroom 102 - 9/15/2025, 1:27:20 PM</li><li class="completed">Bathroom 92-1-1 - 9/15/2025, 12:39:33 PM</li><li class="completed">Bathroom 92-1-2 - 9/15/2025, 12:47:04 PM</li></ul><h3>Tuesday</h3><ul><li class="completed">Room 118 - 9/15/2025, 12:56:03 PM</li><li class="completed">Bathroom 118 - 9/15/2025, 12:47:40 PM</li><li class="completed">Entrance E - 9/15/2025, 2:02:05 PM</li><li class="completed">Hallway 92-1 - 9/15/2025, 2:42:45 PM</li></ul><h3>Wednesday</h3><ul><li class="completed">Studio - 9/15/2025, 1:41:01 PM</li><li class="completed">Stairwell C - 9/15/2025, 1:40:07 PM</li><li class="completed">Stairwell D - 9/15/2025, 1:40:30 PM</li><li class="completed">Stairwell E - 9/15/2025, 1:00:10 PM</li><li class="completed">Stairwell B - 9/15/2025, 1:45:53 PM</li><li class="pending">Worship Center</li><li class="pending">Worship Center Balcony</li><li class="pending">Hallway 92-2</li><li class="pending">Hallway 92-3</li></ul><h3>Thursday</h3><ul><li class="pending">Bathroom 92-2-1</li><li class="pending">Bathroom 92-2-2</li><li class="pending">Bathroom 92-3-1</li><li class="pending">Bathroom 92-3-2</li><li class="pending">Room 254</li><li class="pending">Room 255</li><li class="pending">Hallway 25-2</li><li class="pending">Refill Baptistry</li></ul></div>
  <div class="schedule-name" id="scheduleName">Schedule: Colerain-Week3</div>

<script>
  const housekeeperNames = { A: 'Brian', B: 'Thomas', C: 'Lisa', D: 'Garrett' };
  const weekdayOrder = ['Any', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

  function parseCsv(text) {
    const lines = text.trim().split('\n').filter(line => line.trim() !== '');
    const headers = lines[0].split(/\t|,/).map(h => h.trim());
    return lines.slice(1).map(line => {
      const values = line.split(/\t|,/);
      const obj = {};
      headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
      return obj;
    });
  }

  function getMonday(date = new Date()) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() + diff);
    return d;
  }

  function getWeekOfMonth(mondayDate) {
    const year = mondayDate.getFullYear();
    const month = mondayDate.getMonth();
    const firstOfMonth = new Date(year, month, 1);
    let mondayCount = 0;
    let current = new Date(firstOfMonth);
    while (current <= mondayDate) {
      if (current.getDay() === 1) mondayCount++;
      current.setDate(current.getDate() + 1);
    }
    return mondayCount;
  }

  async function load() {
    const assignmentsDiv = document.getElementById('assignments');
    const progressBar = document.getElementById('progress');
    const scheduleNameDiv = document.getElementById('scheduleName');

    const monday = getMonday();
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);

    const weekNumber = getWeekOfMonth(monday);
    const scheduleFilename = `schedules/Colerain-Week${weekNumber}.csv`;
    scheduleNameDiv.textContent = `Schedule: Colerain-Week${weekNumber}`;

    let scheduleText, tasksText;
    try {
      const scheduleResponse = await fetch(scheduleFilename);
      if (!scheduleResponse.ok) throw new Error(`File not found: ${scheduleFilename}`);
      scheduleText = await scheduleResponse.text();
    } catch (err) {
      assignmentsDiv.innerHTML = `<p style="color:red;">Could not load schedule file: ${err.message}</p>`;
      return;
    }

    try {
      const tasksResponse = await fetch('schedules/colerain-tasks.csv');
      if (!tasksResponse.ok) throw new Error('Could not load additional tasks file');
      tasksText = await tasksResponse.text();
    } catch (err) {
      assignmentsDiv.innerHTML = `<p style="color:red;">Could not load additional tasks file: ${err.message}</p>`;
      return;
    }

    const scheduleData = parseCsv(scheduleText);
    const tasksData = parseCsv(tasksText);

    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';

    const submissionsData = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&limit=1000`)
      .then(res => res.json())
      .then(json => json.content || []);

    const resetTimes = {};
    const validSubmissions = {};

    for (const sub of submissionsData) {
      const createdAt = new Date(sub.created_at);
      const roomRaw = sub.answers?.[roomFieldId]?.answer?.trim() || '';
      const roomName = roomRaw.replace(/reset/i, '').trim();
      if (!roomName) continue;

      if (createdAt < monday || createdAt > sunday) continue;

      if (/reset/i.test(roomRaw)) {
        if (!resetTimes[roomName] || createdAt > resetTimes[roomName]) {
          resetTimes[roomName] = createdAt;
        }
      } else {
        if (!validSubmissions[roomName] || createdAt > validSubmissions[roomName].date) {
          validSubmissions[roomName] = { date: createdAt, raw: roomRaw };
        }
      }
    }

    const statusMap = {};
    for (const room in validSubmissions) {
      const submissionDate = validSubmissions[room].date;
      if (!resetTimes[room] || submissionDate > resetTimes[room]) {
        statusMap[room] = { completed: true, date: submissionDate };
      }
    }

    const resetRooms = new Set();
    for (const room in resetTimes) {
      if (!statusMap[room]) {
        resetRooms.add(room);
      }
    }

    const grouped = {};

    function getName(initial) {
      return housekeeperNames[initial] || initial;
    }

    const combinedTasks = [...scheduleData, ...tasksData];

    for (const task of combinedTasks) {
      const day = task.Day || 'Any';
      const hk = getName(task.Housekeeper || task.Assigned || task['Assigned To']);
      const room = task['Room Name'];
      const link = task.FormLink || task.Link || '';
      if (!hk || !room) continue;

      if (!grouped[hk]) grouped[hk] = {};
      if (!grouped[hk][day]) grouped[hk][day] = [];
      grouped[hk][day].push({ room: room, link: link });
    }

    let totalRooms = 0, completedRooms = 0;
    let html = '';

    Object.entries(grouped).forEach(([hkName, days]) => {
      let hkTotal = 0;
      let hkCompleted = 0;

      weekdayOrder.forEach(day => {
        const rooms = days[day] || [];
        hkTotal += rooms.length;
        rooms.forEach(({ room }) => {
          if (statusMap[room]) hkCompleted++;
        });
      });

      const hkPending = hkTotal - hkCompleted;
      html += `<h2>${hkName} (${hkPending} remaining)</h2>`;

      weekdayOrder.forEach(day => {
        const rooms = days[day] || [];
        if (!rooms.length) return;

        html += `<h3>${day}</h3><ul>`;
        rooms.forEach(({ room, link }) => {
          totalRooms++;
          let extra = '';
          let cls = '';

          if (statusMap[room]) {
            completedRooms++;
            cls = 'completed';
            extra = ` - ${statusMap[room].date.toLocaleString()}`;
          } else if (resetRooms.has(room)) {
            cls = 'returned';
            extra = ' - Returned to Schedule';
          } else {
            cls = 'pending';
          }

          const roomDisplay = link
            ? `<a href="${link}" target="_blank" rel="noopener noreferrer">${room}</a>`
            : room;

          html += `<li class="${cls}">${roomDisplay}${extra}</li>`;
        });
        html += `</ul>`;
      });
    });

    if (totalRooms === 0) {
      assignmentsDiv.innerHTML = `<p class="no-pending">No assignments found.</p>`;
      progressBar.style.width = '100%';
      progressBar.textContent = '100%';
      return;
    }

    if (completedRooms === totalRooms) {
      html += `<p class="no-pending">All rooms are completed this week!</p>`;
    }

    assignmentsDiv.innerHTML = html;

    const percent = totalRooms > 0 ? Math.round((completedRooms / totalRooms) * 100) : 100;
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
  }

  load().catch(err => {
    document.getElementById('assignments').innerHTML = `<p style="color:red;">Error loading assignments: ${err.message}</p>`;
    console.error(err);
  });

  setInterval(() => location.reload(), 300000); // Refresh every 5 minutes
</script>


</body></html>