<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Room Check-In Status (This Week)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      max-width: 100vw;
      overflow-x: hidden;
    }
    h2 {
      margin-bottom: 0.2em;
    }
    #week-range, #completion-percentage {
      font-weight: bold;
      margin-bottom: 1em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      display: block;
    }
    thead {
      background-color: #f2f2f2;
      cursor: pointer;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
      white-space: nowrap;
    }
    .status-ok {
      background-color: #d4edda;
      color: #155724;
      font-weight: bold;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
      font-weight: bold;
    }
    input#filter-input {
      margin-bottom: 1em;
      padding: 5px;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }
    /* Mobile: reduce padding & font size */
    @media (max-width: 600px) {
      th, td {
        padding: 6px 8px;
        font-size: 14px;
      }
      input#filter-input {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h2>Room Check-Ins This Week (Mon-Sun)</h2>
  <div id="week-range"></div>
  <div id="completion-percentage"></div>
  <input type="text" id="filter-input" placeholder="Filter rooms or status..." />

  <table id="status-table">
    <thead>
      <tr>
        <th data-column="room" data-order="desc">Room â–²â–¼</th>
        <th data-column="status" data-order="desc">Status â–²â–¼</th>
        <th data-column="lastDate" data-order="desc">Last Checked In â–²â–¼</th>
        <th data-column="count" data-order="desc">Submissions â–²â–¼</th>
        <th data-column="completedBy" data-order="desc">Completed By â–²â–¼</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // CONFIG
    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';       // Field ID for room (space)
    const completedByFieldId = '29'; // Field ID for completed by

    // Load rooms from external CSV file (must be on same origin or CORS-enabled)
    async function loadRooms() {
      const response = await fetch('rooms.csv');
      const text = await response.text();
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    }

    // Get start & end of current week (Mon-Sun)
    function getWeekBounds() {
      const now = new Date();
      const day = now.getDay(); // Sunday=0, Monday=1...
      const diffToMonday = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setHours(0, 0, 0, 0);
      monday.setDate(now.getDate() + diffToMonday);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { monday, sunday };
    }

    function formatDate(date) {
      if (!date) return '';
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // Parse URL query parameters for filtering
    function getUrlFilter() {
      const params = new URLSearchParams(window.location.search);
      return params.get('filter') || '';
    }

    // Sorting helper
    function compare(a, b, asc = true) {
      if (a === null) return 1;
      if (b === null) return -1;
      if (typeof a === 'string') a = a.toLowerCase();
      if (typeof b === 'string') b = b.toLowerCase();
      if (a < b) return asc ? -1 : 1;
      if (a > b) return asc ? 1 : -1;
      return 0;
    }

    // Main function
    async function main() {
      const { monday, sunday } = getWeekBounds();

      // Show week range
      document.getElementById('week-range').textContent =
        `Week: ${monday.toLocaleDateString()} - ${sunday.toLocaleDateString()}`;

      const allRooms = await loadRooms();

      // Fetch submissions
      const res = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}`);
      const data = await res.json();
      const submissions = data.content || [];

      // Filter submissions by this week and organize by room
      const roomsMap = new Map(); // room => {count, lastDate, completedBy}

      submissions.forEach(sub => {
        const createdAt = new Date(sub.created_at);
        if (createdAt < monday || createdAt > sunday) return;

        const roomName = sub.answers[roomFieldId]?.answer?.trim();
        if (!roomName) return;

        const completedBy = sub.answers[completedByFieldId]?.answer?.trim() || '';

        if (!roomsMap.has(roomName)) {
          roomsMap.set(roomName, { count: 0, lastDate: null, completedBy: completedBy });
        }
        const entry = roomsMap.get(roomName);
        entry.count++;
        if (!entry.lastDate || createdAt > entry.lastDate) {
          entry.lastDate = createdAt;
          entry.completedBy = completedBy;
        }
      });

      // Build rows data
      const rows = allRooms.map(room => {
        const entry = roomsMap.get(room);
        const completed = !!entry;
        return {
          room,
          status: completed ? 'âœ… Complete' : 'ðŸŸ¡ Pending',
          lastDate: entry ? entry.lastDate : null,
          count: entry ? entry.count : 0,
          completedBy: entry ? entry.completedBy : '',
        };
      });

      // Calculate completion %
      const completedCount = rows.filter(r => r.status === 'âœ… Complete').length;
      const completionPercent = ((completedCount / rows.length) * 100).toFixed(1);
      document.getElementById('completion-percentage').textContent =
        `Completion: ${completedCount} / ${rows.length} rooms (${completionPercent}%)`;

      // Render table
      const tbody = document.querySelector('#status-table tbody');
      tbody.innerHTML = '';

      function renderRows(dataRows) {
        tbody.innerHTML = '';
        dataRows.forEach(row => {
          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${row.room}</td>
              <td class="${row.status.includes('âœ…') ? 'status-ok' : 'status-pending'}">${row.status}</td>
              <td>${formatDate(row.lastDate)}</td>
              <td>${row.count}</td>
              <td>${row.completedBy}</td>
            </tr>
          `);
        });
      }

      // Initial render
      renderRows(rows);

      // Filtering
      const filterInput = document.getElementById('filter-input');
      const urlFilter = getUrlFilter().toLowerCase();
      if (urlFilter) {
        filterInput.value = urlFilter;
      }

      function applyFilter() {
        const filter = filterInput.value.toLowerCase();
        const filtered = rows.filter(r =>
          r.room.toLowerCase().includes(filter) ||
          r.status.toLowerCase().includes(filter) ||
          (r.completedBy && r.completedBy.toLowerCase().includes(filter)) ||
          (r.count.toString().includes(filter)) ||
          (r.lastDate && formatDate(r.lastDate).toLowerCase().includes(filter))
        );
        renderRows(filtered);
      }
      filterInput.addEventListener('input', applyFilter);
      if (urlFilter) applyFilter();

      // Sorting
      const headers = document.querySelectorAll('#status-table thead th');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const column = header.getAttribute('data-column');
          const currentOrder = header.getAttribute('data-order');
          const asc = currentOrder === 'desc';
          headers.forEach(h => h.setAttribute('data-order', 'desc'));
          header.setAttribute('data-order', asc ? 'asc' : 'desc');

          const sorted = [...rows].sort((a, b) => {
            return compare(a[column], b[column], asc);
          });
          renderRows(sorted);
        });
      });
    }

    main().catch(err => {
      console.error(err);
      document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">Error loading data</p>');
    });
  </script>
</body>
</html>
