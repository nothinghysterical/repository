<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Room Check-In Status (This Week)</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }

    h2, h3 {
      margin-bottom: 0.5rem;
    }

    .info-bar {
      margin-bottom: 1rem;
      font-weight: bold;
    }

    .filter-bar {
      margin-bottom: 1rem;
    }

    input[type="text"] {
      padding: 5px;
      width: 100%;
      max-width: 300px;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
    }

    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
      white-space: nowrap;
    }

    th {
      cursor: pointer;
      background-color: #f4f4f4;
    }

    .status-ok {
      background-color: #d4edda;
      color: #155724;
      font-weight: bold;
    }

    .status-missing {
      background-color: #f8d7da;
      color: #721c24;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      table {
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <h2>Room Check-Ins This Week</h2>
  <div class="info-bar" id="date-range"></div>
  <div class="info-bar" id="completion-rate"></div>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Filter rooms..." />
  </div>

  <div class="table-wrapper">
    <table id="status-table">
      <thead>
        <tr>
          <th onclick="sortTable('room')">Room</th>
          <th onclick="sortTable('status')">Status</th>
          <th onclick="sortTable('count')">Count</th>
          <th onclick="sortTable('latest')">Latest</th>
          <th onclick="sortTable('completedBy')">Completed By</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';
    const completedByFieldId = '29';

    let allRooms = [];
    let tableData = [];
    let currentSortField = 'room';
    let currentSortAsc = true;

    function getWeekBounds() {
      const now = new Date();
      const day = now.getDay();
      const diffToMonday = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setHours(0,0,0,0);
      monday.setDate(now.getDate() + diffToMonday);

      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23,59,59,999);
      return { monday, sunday };
    }

    function updateWeekDisplay(monday, sunday) {
      const options = { month: 'short', day: 'numeric' };
      document.getElementById('date-range').textContent = 
        `Week of ${monday.toLocaleDateString(undefined, options)} – ${sunday.toLocaleDateString(undefined, options)}`;
    }

    function updateCompletionRate(completeCount, totalCount) {
      const percent = ((completeCount / totalCount) * 100).toFixed(1);
      document.getElementById('completion-rate').textContent = 
        `${completeCount} of ${totalCount} rooms completed (${percent}%)`;
    }

    function renderTable() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      const tbody = document.querySelector("#status-table tbody");
      tbody.innerHTML = '';

      const filtered = tableData.filter(row => row.room.toLowerCase().includes(filter));

      filtered.forEach(row => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${row.room}</td>
            <td class="${row.status.includes('✅') ? 'status-ok' : 'status-missing'}">${row.status}</td>
            <td>${row.count}</td>
            <td>${row.latest}</td>
            <td>${row.completedBy}</td>
          </tr>
        `);
      });
    }

    function sortTable(field) {
      if (currentSortField === field) {
        currentSortAsc = !currentSortAsc;
      } else {
        currentSortField = field;
        currentSortAsc = true;
      }

      tableData.sort((a, b) => {
        let valA = a[field], valB = b[field];
        if (field === 'count') {
          valA = parseInt(valA); valB = parseInt(valB);
        } else {
          valA = valA || ""; valB = valB || "";
        }
        if (valA < valB) return currentSortAsc ? -1 : 1;
        if (valA > valB) return currentSortAsc ? 1 : -1;
        return 0;
      });

      renderTable();
    }

    function getURLParams() {
      const params = {};
      window.location.search.slice(1).split('&').forEach(part => {
        const [key, value] = part.split('=').map(decodeURIComponent);
        if (key) params[key] = value;
      });
      return params;
    }

    document.getElementById("searchInput").addEventListener("input", renderTable);

    const { monday, sunday } = getWeekBounds();
    updateWeekDisplay(monday, sunday);

    fetch('rooms.csv')
      .then(res => res.text())
      .then(csv => {
        allRooms = csv.trim().split('\n').map(line => line.trim()).filter(Boolean);
        return fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}`);
      })
      .then(res => res.json())
      .then(data => {
        const submissions = data.content || [];
        const roomData = {};

        submissions.forEach(sub => {
          const submittedAt = new Date(sub.created_at);
          if (submittedAt >= monday && submittedAt <= sunday) {
            const roomName = sub.answers[roomFieldId]?.answer?.trim();
            const completedBy = sub.answers[completedByFieldId]?.answer?.trim() || "—";

            if (roomName) {
              if (!roomData[roomName]) {
                roomData[roomName] = { count: 0, latest: null, completedBy: "" };
              }

              roomData[roomName].count += 1;

              if (!roomData[roomName].latest || submittedAt > roomData[roomName].latest) {
                roomData[roomName].latest = submittedAt;
                roomData[roomName].completedBy = completedBy;
              }
            }
          }
        });

        tableData = allRooms.map(room => {
          const entry = roomData[room];
          return {
            room,
            status: entry ? '✅ Turned In' : '❌ Missing',
            count: entry?.count || 0,
            latest: entry?.latest ? entry.latest.toLocaleDateString() : '—',
            completedBy: entry?.completedBy || '—'
          };
        });

        const completedCount = tableData.filter(row => row.status.includes('✅')).length;
        updateCompletionRate(completedCount, tableData.length);

        const params = getURLParams();
        if (params.filter) {
          document.getElementById("searchInput").value = params.filter;
        }

        sortTable('room');
      })
      .catch(err => {
        console.error(err);
        document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">Error loading data</p>');
      });
  </script>
</body>
</html>
