<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Cleaning Shifts (With Usage & Completion)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { text-align: center; }
    .shift { margin-bottom: 30px; padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    .room-entry { margin-left: 20px; }
  </style>
</head>
<body>
  <h1>Organized Room Cleaning Shifts (4 Hours Each)</h1>
  <div id="shifts"></div>

  <script>
    const jotformApiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';
    const completedByFieldId = '29';
    const calendarId = '46885';
    const planningCenterToken = '2000d9a797cde02a3a2a2a5b02078c762db7a2300232b7f806e7f5be9bb1be22';
    const shiftDuration = 240; // in minutes
    const people = ['Garrett', 'Thomas'];

    function getWeekBounds() {
      const now = new Date();
      const day = now.getDay();
      const diffToMonday = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setHours(0, 0, 0, 0);
      monday.setDate(now.getDate() + diffToMonday);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { monday, sunday };
    }

    function parseCSV(text) {
      return text.trim().split('\n').slice(1).map(line => {
        const [name, priority, minutes] = line.split(',').map(s => s.trim());
        return {
          name,
          basePriority: parseInt(priority),
          time: parseInt(minutes),
        };
      });
    }

    async function fetchSubmissions() {
      const { monday, sunday } = getWeekBounds();
      const res = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${jotformApiKey}`);
      const data = await res.json();
      const content = data.content || [];
      const completedMap = new Map();

      for (const sub of content) {
        const createdAt = new Date(sub.created_at);
        if (createdAt < monday || createdAt > sunday) continue;

        const room = sub.answers?.[roomFieldId]?.answer?.trim();
        if (!room) continue;
        const last = completedMap.get(room);
        if (!last || createdAt > last) completedMap.set(room, createdAt);
      }

      return completedMap;
    }

    async function fetchCalendarUsage() {
      const { monday } = getWeekBounds();
      const today = new Date();
      const daysMap = new Map();

      let page = 1;
      while (true) {
        const url = `https://api.planningcenteronline.com/calendar/v2/calendars/${calendarId}/event_instances?page=${page}`;
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${planningCenterToken}` },
        });
        const data = await res.json();
        if (!data.data?.length) break;

        for (const ev of data.data) {
          const roomName = ev.attributes.name;
          const endTime = new Date(ev.attributes.ends_at);
          if (endTime > today) continue;
          const daysAgo = Math.floor((today - endTime) / (1000 * 60 * 60 * 24));
          if (!daysMap.has(roomName) || daysAgo < daysMap.get(roomName)) {
            daysMap.set(roomName, daysAgo);
          }
        }

        if (!data.links?.next) break;
        page++;
      }

      return daysMap;
    }

    async function main() {
      const csv = await fetch('rooms-shifts.csv').then(res => res.text());
      const rooms = parseCSV(csv);
      const completedMap = await fetchSubmissions();
      const usageMap = await fetchCalendarUsage();

      // Adjust priorities
      for (const room of rooms) {
        let adjusted = room.basePriority;

        if (completedMap.has(room.name)) adjusted = Math.min(adjusted + 4, 10);
        if (usageMap.has(room.name)) adjusted -= usageMap.get(room.name);

        room.priority = Math.max(1, adjusted);
        room.lastCompleted = completedMap.get(room.name);
        room.daysAgoUsed = usageMap.get(room.name);
      }

      rooms.sort((a, b) => a.priority - b.priority);

      const shifts = [];
      let shift = { total: 0, rooms: [], person: people[0] };
      let personIndex = 0;

      for (const room of rooms) {
        if (shift.total + room.time > shiftDuration) {
          shifts.push(shift);
          personIndex = (personIndex + 1) % people.length;
          shift = { total: 0, rooms: [], person: people[personIndex] };
        }
        shift.total += room.time;
        shift.rooms.push(room);
      }
      if (shift.rooms.length > 0) shifts.push(shift);

      const container = document.getElementById('shifts');
      container.innerHTML = '';

      shifts.forEach((shift, i) => {
        const div = document.createElement('div');
        div.className = 'shift';
        div.innerHTML = `<h2>Shift ${i + 1} - Assigned to: ${shift.person} (Total: ${shift.total} min)</h2>`;
        shift.rooms.forEach(room => {
          let extra = '';
          if (room.lastCompleted) {
            const days = Math.floor((Date.now() - new Date(room.lastCompleted)) / (1000 * 60 * 60 * 24));
            extra += ` (last completed: ${days} day${days === 1 ? '' : 's'} ago)`;
          }
          if (room.daysAgoUsed !== undefined) {
            extra += ` (last used: ${room.daysAgoUsed} day${room.daysAgoUsed === 1 ? '' : 's'} ago)`;
          }
          div.innerHTML += `<div class="room-entry">${room.name} - Priority ${room.priority}, ${room.time} min${extra}</div>`;
        });
        container.appendChild(div);
      });
    }

    main().catch(err => {
      document.body.insertAdjacentHTML('beforeend', '<p style="color:red">Error loading data: ' + err.message + '</p>');
      console.error(err);
    });
  </script>
</body>
</html>
