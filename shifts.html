<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organized Room Cleaning Shifts (4 Hours Each)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .shift {
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 20px auto;
      padding: 10px 20px;
      max-width: 800px;
      background-color: #f9f9f9;
    }
    .room {
      margin: 4px 0;
    }
    .bold {
      font-weight: bold;
    }
    .priority-label {
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Organized Room Cleaning Shifts (4 Hours Each)</h1>
  <div id="shifts-container"></div>

  <script>
    async function fetchRoomData() {
      const [roomRes, jotformRes, calendarRes] = await Promise.all([
        fetch('rooms-shifts.csv').then(r => r.text()),
        fetch('https://api.jotform.com/form/250955404825056/submissions?apiKey=5b9a10e2092947d49dac84004ad149a2').then(r => r.json()),
        fetch('https://api.planningcenteronline.com/calendar/v2/calendars/46885/event_instances', {
          headers: {
            'Authorization': 'Bearer 2000d9a797cde02a3a2a2a5b02078c762db7a2300232b7f806e7f5be9bb1be22'
          }
        }).then(r => r.json())
      ]);

      const lines = roomRes.trim().split('\n');
      const roomHeaders = lines[0].split(',');
      const roomData = lines.slice(1).map(l => {
        const [name, priority, minutes] = l.split(',');
        return { name: name.trim(), priority: parseInt(priority), minutes: parseInt(minutes), lastCompletedDays: null, usedDaysAgo: [], usedSoon: false };
      });

      const submissions = jotformRes.content || [];
      const roomFieldId = '18';
      const now = new Date();
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay() + 1);
      weekStart.setHours(0,0,0,0);

      for (const room of roomData) {
        const relevantSubs = submissions.filter(sub => {
          const date = new Date(sub.created_at);
          const answer = sub.answers?.[roomFieldId]?.answer?.trim();
          return answer === room.name && date >= weekStart && date <= now;
        });
        if (relevantSubs.length > 0) {
          const lastDate = new Date(relevantSubs.map(s => s.created_at).sort().reverse()[0]);
          const daysAgo = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
          room.priority += 4;
          room.lastCompletedDays = daysAgo;
        }
      }

      const events = calendarRes.data || [];
      for (const event of events) {
        const start = new Date(event.attributes.starts_at);
        const name = event.attributes.title;
        for (const room of roomData) {
          if (name.toLowerCase().includes(room.name.toLowerCase())) {
            const daysDiff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
            if (start > now && start < new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000)) {
              room.usedSoon = true;
            }
            if (daysDiff >= 1) {
              room.priority -= daysDiff;
              room.usedDaysAgo.push(daysDiff);
            }
          }
        }
      }

      roomData.sort((a, b) => a.priority - b.priority);

      const shifts = [];
      let currentShift = { rooms: [], total: 0, assignee: '' };
      const assignees = ['Garrett', 'Thomas'];
      let assigneeIndex = 0;

      for (const room of roomData) {
        if (currentShift.total + room.minutes > 240) {
          currentShift.assignee = assignees[assigneeIndex % assignees.length];
          shifts.push(currentShift);
          currentShift = { rooms: [], total: 0, assignee: '' };
          assigneeIndex++;
        }
        currentShift.rooms.push(room);
        currentShift.total += room.minutes;
      }
      if (currentShift.rooms.length > 0) {
        currentShift.assignee = assignees[assigneeIndex % assignees.length];
        shifts.push(currentShift);
      }

      const container = document.getElementById('shifts-container');
      shifts.forEach((shift, idx) => {
        const div = document.createElement('div');
        div.className = 'shift';
        div.innerHTML = `<h2>Shift ${idx + 1} - Assigned to: ${shift.assignee} (Total: ${shift.total} min)</h2>`;
        shift.rooms.forEach(room => {
          const boldClass = room.usedSoon ? 'bold' : '';
          const daysText = room.lastCompletedDays !== null ? ` (last completed: ${room.lastCompletedDays} day${room.lastCompletedDays === 1 ? '' : 's'} ago)` : '';
          div.innerHTML += `<div class="room ${boldClass}">${room.name} <span class="priority-label">- Priority ${room.priority}, ${room.minutes} min${daysText}</span></div>`;
        });
        container.appendChild(div);
      });
    }

    fetchRoomData().catch(err => {
      console.error(err);
      document.body.insertAdjacentHTML('beforeend', '<p style="color:red;">Error loading shift data</p>');
    });
  </script>
</body>
</html>
