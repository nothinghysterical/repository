<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cleaning Tasks for Today</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      background: #f9f9f9;
    }
    h2 {
      margin-top: 1.5em;
    }
    .late {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Cleaning Tasks for Today (and Overdue)</h1>
  <input type="file" id="csvInput" accept=".csv" />
  <div id="results"></div>

  <script>
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dayOfWeekMap = {
      Sunday: 0,
      Monday: 1,
      Tuesday: 2,
      Wednesday: 3,
      Thursday: 4,
      Friday: 5,
      Saturday: 6
    };

    function getDateThisWeek(dayName) {
      const now = new Date();
      const todayIdx = now.getDay();
      const targetIdx = dayOfWeekMap[dayName];
      const diff = targetIdx - todayIdx;
      const result = new Date(now);
      result.setDate(now.getDate() + diff);
      result.setHours(0, 0, 0, 0);
      return result;
    }

    function formatDateDiff(lastDate) {
      if (!lastDate) return "never";
      const diffTime = today - new Date(lastDate);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return `${diffDays} day${diffDays === 1 ? "" : "s"} ago`;
    }

    function handleCSV(content) {
      const lines = content.trim().split(/\r?\n/);
      const header = lines.shift(); // skip header

      const tasksByPerson = {};
      const roomLastCompleted = new Map(); // Simulate with empty Map unless provided

      lines.forEach(line => {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length < 6) return;

        const [room, campus, priorityStr, timeStr, assignedRaw, dayNameRaw] = parts;
        const priority = parseInt(priorityStr, 10);
        const time = parseInt(timeStr, 10);
        const assigned = assignedRaw || "Unassigned";
        const dayName = dayNameRaw;

        if (!room || isNaN(priority) || isNaN(time) || !dayName) return;

        const scheduledDate = getDateThisWeek(dayName);
        if (scheduledDate > today) return; // future task

        let adjustedPriority = priority;
        const lastCompleted = roomLastCompleted.get(room);
        if (lastCompleted) {
          adjustedPriority += 4;
        }

        const task = {
          name: room,
          priority: adjustedPriority,
          originalPriority: priority,
          time,
          day: dayName,
          lastCompleted
        };

        if (!tasksByPerson[assigned]) tasksByPerson[assigned] = [];
        tasksByPerson[assigned].push(task);
      });

      renderResults(tasksByPerson);
    }

    function renderResults(tasksByPerson) {
      const container = document.getElementById("results");
      container.innerHTML = "";

      Object.entries(tasksByPerson).forEach(([person, tasks]) => {
        const header = document.createElement("h2");
        header.textContent = `${person} – Total: ${tasks.reduce((a, b) => a + b.time, 0)} min`;
        container.appendChild(header);

        const ul = document.createElement("ul");
        tasks
          .sort((a, b) => b.priority - a.priority)
          .forEach(task => {
            const li = document.createElement("li");
            const isLate = task.lastCompleted == null;
            if (isLate) li.classList.add("late");

            const lastCompletedText = task.lastCompleted
              ? `(last completed: ${formatDateDiff(task.lastCompleted)})`
              : "";

            li.textContent = `${task.name} ${lastCompletedText} – Priority ${task.priority}, ${task.time} min (Scheduled: ${task.day})`;
            ul.appendChild(li);
          });

        container.appendChild(ul);
      });
    }

    document.getElementById("csvInput").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        handleCSV(reader.result);
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
