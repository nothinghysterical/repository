<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Today's Cleaning Tasks by Person</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
    }
    h1 {
      text-align: center;
    }
    .person {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      background-color: #f0f8ff;
    }
    .person h2 {
      margin-top: 0;
    }
    ul {
      padding-left: 1.2em;
    }
  </style>
</head>
<body>
  <h1>Cleaning Tasks for Today (and Overdue)</h1>
  <div id="person-container"></div>

  <script>
    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';

    const dayToIndex = {
      Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6
    };

    function getWeekMonday() {
      const now = new Date();
      const day = now.getDay();
      const diff = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setDate(now.getDate() + diff);
      monday.setHours(0, 0, 0, 0);
      return monday;
    }

    function getDateThisWeek(dayName) {
      const monday = getWeekMonday();
      const dayOffset = dayToIndex[dayName];
      const date = new Date(monday);
      date.setDate(monday.getDate() + dayOffset);
      return date;
    }

    function daysAgo(dateString) {
      const submitted = new Date(dateString);
      const now = new Date();
      const diffMs = now - submitted;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    async function loadAndGroupByPerson() {
      const monday = getWeekMonday();
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);

      let submissions = [];
      try {
        const res = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&filter[created_at][from]=${monday.toISOString()}&filter[created_at][to]=${sunday.toISOString()}&limit=1000`);
        const data = await res.json();
        submissions = data.content || [];
      } catch(e) {
        console.error('Error fetching JotForm submissions', e);
      }

      const roomLastCompleted = new Map();
      submissions.forEach(sub => {
        const roomName = sub.answers?.[roomFieldId]?.answer?.trim();
        if (roomName) {
          const createdAt = new Date(sub.created_at);
          if (!roomLastCompleted.has(roomName) || createdAt > roomLastCompleted.get(roomName)) {
            roomLastCompleted.set(roomName, createdAt);
          }
        }
      });

      const response = await fetch('rooms-shifts.csv');
      const csvText = await response.text();

      const lines = csvText.trim().split('\n');
      const dataLines = lines.slice(1);

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const tasksByPerson = {};

      dataLines.forEach(line => {
        const [name, campus, priorityStr, timeStr, assigned, dayName] = line.split(',').map(s => s.trim());
        const priority = parseInt(priorityStr);
        const time = parseInt(timeStr);
        const scheduledDate = getDateThisWeek(dayName);

        if (scheduledDate > today) return; // skip future rooms

        let adjustedPriority = priority;
        if (roomLastCompleted.has(name)) {
          adjustedPriority += 4;
        }

        const task = {
          name,
          priority: adjustedPriority,
          originalPriority: priority,
          time,
          day: dayName,
          lastCompleted: roomLastCompleted.get(name) || null
        };

        if (!tasksByPerson[assigned]) tasksByPerson[assigned] = [];
        tasksByPerson[assigned].push(task);
      });

      const container = document.getElementById('person-container');
      container.innerHTML = '';

      Object.entries(tasksByPerson).forEach(([person, tasks]) => {
        tasks.sort((a, b) => a.priority - b.priority || b.time - a.time);
        const totalTime = tasks.reduce((sum, t) => sum + t.time, 0);

        const ulHTML = tasks.map(task => {
          let lastStr = '';
          if (task.lastCompleted) {
            const days = daysAgo(task.lastCompleted);
            lastStr = ` (last completed: ${days} day${days !== 1 ? 's' : ''} ago)`;
          }
          return `<li>${task.name}${lastStr} – Priority ${task.priority}, ${task.time} min (Scheduled: ${task.day})</li>`;
        }).join('');

        const div = document.createElement('div');
        div.className = 'person';
        div.innerHTML = `<h2>${person} – Total: ${totalTime} min</h2><ul>${ulHTML}</ul>`;
        container.appendChild(div);
      });
    }

    loadAndGroupByPerson();
  </script>
</body>
</html>
