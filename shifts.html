<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Room Schedule Status</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>Room Schedule Report</h1>
  <input type="file" id="csvFileInput" accept=".csv" />
  <h2>Due Today</h2>
  <ul id="dueToday"></ul>
  <h2>Overdue</h2>
  <ul id="overdue"></ul>

  <script>
    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';

    const fetchCompletedRooms = async () => {
      const response = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}`);
      const data = await response.json();

      const today = new Date().toDateString();
      const completed = new Set();

      data.content.forEach(submission => {
        const room = submission.answers?.[roomFieldId]?.answer?.trim();
        const date = new Date(submission.created_at).toDateString();
        if (room && date === today) {
          completed.add(room);
        }
      });

      return completed;
    };

    const getWeekdayDate = (weekday) => {
      const today = new Date();
      const todayDay = today.getDay();
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const targetDay = dayNames.indexOf(weekday);

      const diff = (targetDay - todayDay + 7) % 7;
      const thisWeek = new Date(today);
      thisWeek.setDate(today.getDate() + diff - (diff === 0 ? 7 : 0)); // find last weekday (including today)

      return thisWeek;
    };

    const parseCSVAndCompare = async (file) => {
      const completedRooms = await fetchCompletedRooms();
      Papa.parse(file, {
        header: true,
        complete: (results) => {
          const todayStr = new Date().toDateString();
          const dueToday = [];
          const overdue = [];

          results.data.forEach(room => {
            const roomName = room.Room?.trim();
            const assignedDay = room.Day?.trim();
            const dueDate = getWeekdayDate(assignedDay);

            if (!roomName || isNaN(dueDate)) return;

            const roomDueStr = dueDate.toDateString();
            const isCompletedToday = completedRooms.has(roomName);

            if (roomDueStr === todayStr && !isCompletedToday) {
              dueToday.push(roomName);
            } else if (dueDate < new Date() && !completedRooms.has(roomName)) {
              overdue.push(roomName);
            }
          });

          document.getElementById('dueToday').innerHTML = dueToday.map(r => `<li>${r}</li>`).join('');
          document.getElementById('overdue').innerHTML = overdue.map(r => `<li>${r}</li>`).join('');
        }
      });
    };

    document.getElementById('csvFileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) parseCSVAndCompare(file);
    });
  </script>
</body>
</html>
