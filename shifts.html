<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Room Assignments</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Assignments for A</h1>
  <h2>Due today</h2>
  <ul id="dueTodayList"></ul>

  <h2>Overdue</h2>
  <ul id="overdueList"></ul>

  <p id="allDoneMessage" style="font-weight: bold;"></p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const API_KEY = '5b9a10e2092947d49dac84004ad149a2';
    const FORM_ID = '250955404825056';
    const ROOM_FIELD_ID = '18';

    const today = new Date();
    const currentDay = today.toLocaleString('en-US', { weekday: 'long' });
    const previousMonday = new Date(today);
    previousMonday.setDate(today.getDate() - ((today.getDay() + 6) % 7)); // last Monday

    let assignedRooms = [];

    function fetchCSV() {
      fetch('rooms-shifts.csv')
        .then(response => response.text())
        .then(text => {
          const parsed = Papa.parse(text, { header: true });
          assignedRooms = parsed.data.filter(r => r.Assigned === 'A' && r.Room);
          fetchSubmissions();
        });
    }

    async function fetchSubmissions() {
      const response = await fetch(`https://api.jotform.com/form/${FORM_ID}/submissions?apiKey=${API_KEY}`);
      const data = await response.json();
      const submissions = data.content || [];

      const completedRooms = new Set();
      for (let sub of submissions) {
        const createdAt = new Date(sub.created_at);
        if (createdAt >= previousMonday) {
          const roomAnswer = sub.answers?.[ROOM_FIELD_ID]?.answer?.trim();
          if (roomAnswer) {
            completedRooms.add(roomAnswer);
          }
        }
      }

      displayRooms(completedRooms);
    }

    function displayRooms(completedRooms) {
      const dueToday = [];
      const overdue = [];

      for (const room of assignedRooms) {
        if (completedRooms.has(room.Room)) continue;
        if (room.Day === currentDay) {
          dueToday.push(room.Room);
        } else {
          const dayOfWeek = room.Day;
          const dayNum = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"].indexOf(dayOfWeek);
          const roomDate = new Date(previousMonday);
          roomDate.setDate(previousMonday.getDate() + (dayNum - 1)); // offset to correct day

          if (roomDate < today) {
            overdue.push(room.Room);
          }
        }
      }

      const dueList = document.getElementById('dueTodayList');
      const overdueList = document.getElementById('overdueList');
      dueToday.forEach(r => dueList.innerHTML += `<li>${r}</li>`);
      overdue.forEach(r => overdueList.innerHTML += `<li>${r}</li>`);

      if (dueToday.length === 0 && overdue.length === 0) {
        document.getElementById('allDoneMessage').textContent = "See Brian for additional items";
      }
    }

    fetchCSV();
  </script>
</body>
</html>
