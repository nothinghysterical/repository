<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room Cleaning Schedule</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
    }
    h2 {
      margin-top: 2rem;
    }
    ul {
      padding-left: 1.5rem;
    }
    li {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>Room Cleaning Schedule</h1>
  <div id="output"></div>

  <script>
    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';

    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    function getLastMonday(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function loadCSV(path) {
      return fetch(path).then(response => response.text());
    }

    async function fetchTodayCompletions() {
      const today = new Date().toISOString().split('T')[0];
      const url = `https://api.jotform.com/form/${formId}/submissions?apikey=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      const submissions = data.content || [];
      const completedRooms = new Set();

      for (const submission of submissions) {
        const date = new Date(submission.created_at).toISOString().split('T')[0];
        if (date === today) {
          const room = submission.answers?.[roomFieldId]?.answer;
          if (room) completedRooms.add(room.trim());
        }
      }
      return completedRooms;
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split('\t');
      return lines.slice(1).map(line => {
        const values = line.split('\t');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }

    async function generateSchedule() {
      const [csvText, completedRooms] = await Promise.all([
        loadCSV('rooms-shifts.csv'),
        fetchTodayCompletions()
      ]);

      const records = parseCSV(csvText);
      const output = document.getElementById('output');
      const today = new Date();
      const todayDay = daysOfWeek[today.getDay()];
      const lastMonday = getLastMonday(today);
      const overdueDays = daysOfWeek.slice(1, today.getDay());

      const grouped = { A: { today: [], overdue: [] }, B: { today: [], overdue: [] } };

      for (const r of records) {
        const assigned = r.Assigned;
        const roomName = r.Room.trim();
        const scheduledDay = r.Day.trim();

        const scheduledDate = new Date(lastMonday);
        const dayOffset = daysOfWeek.indexOf(scheduledDay);
        scheduledDate.setDate(scheduledDate.getDate() + dayOffset);

        if (completedRooms.has(roomName)) continue;

        if (scheduledDay === todayDay) {
          grouped[assigned].today.push(roomName);
        } else if (overdueDays.includes(scheduledDay)) {
          grouped[assigned].overdue.push(roomName);
        }
      }

      output.innerHTML = '';
      ["A", "B"].forEach(group => {
        output.innerHTML += `<h2>Group ${group}</h2>`;
        output.innerHTML += `<h3>Due Today</h3><ul>` +
          (grouped[group].today.length ? grouped[group].today.map(r => `<li>${r}</li>`).join('') : '<li>No rooms due today</li>') + '</ul>';
        output.innerHTML += `<h3>Overdue</h3><ul>` +
          (grouped[group].overdue.length ? grouped[group].overdue.map(r => `<li>${r}</li>`).join('') : '<li>No overdue rooms</li>') + '</ul>';
      });
    }

    generateSchedule();
  </script>
</body>
</html>
