<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room Cleaning Shifts with Priority Demotion and Last Completed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
    }
    h1 {
      text-align: center;
    }
    .shift {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      background-color: #f9f9f9;
    }
    .shift h2 {
      margin-top: 0;
    }
    ul {
      padding-left: 1.2em;
    }
  </style>
</head>
<body>
  <h1>Organized Room Cleaning Shifts (4 Hours Each)</h1>
  <div id="shift-container"></div>

  <script>
    const apiKey = '5b9a10e2092947d49dac84004ad149a2';
    const formId = '250955404825056';
    const roomFieldId = '18';

    // Helper: get current week Monday and Sunday
    function getWeekBounds() {
      const now = new Date();
      const day = now.getDay();
      const diffToMonday = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setHours(0, 0, 0, 0);
      monday.setDate(now.getDate() + diffToMonday);

      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);

      return { monday, sunday };
    }

    function daysAgo(dateString) {
      const submitted = new Date(dateString);
      const now = new Date();
      const diffMs = now - submitted;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    async function loadAndAssignShifts() {
      // Fetch completed submissions
      const { monday, sunday } = getWeekBounds();
      const startISO = monday.toISOString();
      const endISO = sunday.toISOString();

      let submissions = [];
      try {
        const res = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&filter[created_at][from]=${startISO}&filter[created_at][to]=${endISO}&limit=1000`);
        const data = await res.json();
        submissions = data.content || [];
      } catch(e) {
        console.error('Error fetching JotForm submissions', e);
      }

      // Map: roomName -> most recent submission date
      const roomLastCompleted = new Map();
      submissions.forEach(sub => {
        const roomName = sub.answers?.[roomFieldId]?.answer?.trim();
        if (roomName) {
          const createdAt = new Date(sub.created_at);
          if (!roomLastCompleted.has(roomName) || createdAt > roomLastCompleted.get(roomName)) {
            roomLastCompleted.set(roomName, createdAt);
          }
        }
      });

      // Fetch rooms.csv
      const response = await fetch('rooms.csv');
      const csvText = await response.text();

      const lines = csvText.trim().split('\n');
      const dataLines = lines.slice(1); // skip header

      // Parse rooms, demote priority by 4 if completed
      const rooms = dataLines.map(line => {
        const [name, priorityStr, timeStr] = line.split(',').map(s => s.trim());
        let priority = parseInt(priorityStr);
        const time = parseInt(timeStr);
        if (roomLastCompleted.has(name)) {
          priority += 4;  // demote priority
        }
        return { name, priority, time };
      }).filter(r => r.name && !isNaN(r.priority) && !isNaN(r.time));

      // Sort by priority ascending, then time descending
      rooms.sort((a, b) => a.priority - b.priority || b.time - a.time);

      // Group into shifts of max 240 minutes
      const shifts = [];
      let currentShift = [];
      let currentTime = 0;
      const MAX_SHIFT_MINUTES = 240;

      for (const room of rooms) {
        if (currentTime + room.time > MAX_SHIFT_MINUTES && currentShift.length > 0) {
          shifts.push(currentShift);
          currentShift = [];
          currentTime = 0;
        }
        currentShift.push(room);
        currentTime += room.time;
      }
      if (currentShift.length > 0) shifts.push(currentShift);

      // Assign shifts alternating Garrett and Thomas
      const people = ['Garrett', 'Thomas'];
      const shiftContainer = document.getElementById('shift-container');
      shiftContainer.innerHTML = '';

      shifts.forEach((shift, i) => {
        const assignedTo = people[i % people.length];
        const totalTime = shift.reduce((sum, room) => sum + room.time, 0);

        const ulHTML = shift.map(room => {
          let lastCompletedStr = '';
          if (roomLastCompleted.has(room.name)) {
            const lastDate = roomLastCompleted.get(room.name);
            const days = daysAgo(lastDate);
            lastCompletedStr = ` (last completed: ${days} day${days !== 1 ? 's' : ''} ago)`;
          }
          return `<li>${room.name}${lastCompletedStr} - Priority ${room.priority}, ${room.time} min</li>`;
        }).join('');

        const div = document.createElement('div');
        div.className = 'shift';
        div.innerHTML = `<h2>Shift ${i + 1} - Assigned to: ${assignedTo} (Total: ${totalTime} min)</h2><ul>${ulHTML}</ul>`;
        shiftContainer.appendChild(div);
      });
    }

    loadAndAssignShifts();
  </script>
</body>
</html>
