<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cleaning Tasks for Today (and Overdue)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      background: #f9f9f9;
    }
    h2 {
      margin-top: 1.5em;
    }
    .late {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Cleaning Tasks for Today (and Overdue)</h1>
  <div id="results">Loading tasks...</div>

  <script>
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dayOfWeekMap = {
      Sunday: 0,
      Monday: 1,
      Tuesday: 2,
      Wednesday: 3,
      Thursday: 4,
      Friday: 5,
      Saturday: 6
    };

    function getDateThisWeek(dayName) {
      const now = new Date();
      const todayIdx = now.getDay();
      const targetIdx = dayOfWeekMap[dayName];
      const diff = targetIdx - todayIdx;
      const result = new Date(now);
      result.setDate(now.getDate() + diff);
      result.setHours(0, 0, 0, 0);
      return result;
    }

    function formatDateDiff(lastDate) {
      if (!lastDate) return "never";
      const diffTime = today - new Date(lastDate);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return `${diffDays} day${diffDays === 1 ? "" : "s"} ago`;
    }

    function handleCSV(content) {
      const lines = content.trim().split(/\r?\n/);
      const header = lines.shift();

      const tasksByPerson = {};
      const roomLastCompleted = new Map(); // You can pre-fill this if needed

      lines.forEach(line => {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length < 6) return;

        const [room, campus, priorityStr, timeStr, assignedRaw, dayNameRaw] = parts;
        const priority = parseInt(priorityStr, 10);
        const time = parseInt(timeStr, 10);
        const assigned = assignedRaw || "Unassigned";
        const dayName = dayNameRaw;

        if (!room || isNaN(priority) || isNaN(time) || !dayName) return;

        const scheduledDate = getDateThisWeek(dayName);
        if (scheduledDate > today) return; // skip future tasks

        const lastCompleted = roomLastCompleted.get(room); // default to undefined
        const adjustedPriority = lastCompleted ? priority + 4 : priority;

        const task = {
          name: room,
          priority: adjustedPriority,
          originalPriority: priority,
          time,
          day: dayName,
          lastCompleted
        };

        if (!tasksByPerson[assigned]) tasksByPerson[assigned] = [];
        tasksByPerson[assigned].push(task);
      });

      renderResults(tasksByPerson);
    }

    function renderResults(tasksByPerson) {
      const container = document.getElementById("results");
      container.innerHTML = "";

      Object.entries(tasksByPerson).forEach(([person, tasks]) => {
        const totalTime = tasks.reduce((sum, t) => sum + t.time, 0);
        const h2 = document.createElement("h2");
        h2.textContent = `${person} – Total: ${totalTime} min`;
        container.appendChild(h2);

        const ul = document.createElement("ul");
        tasks
          .sort((a, b) => b.priority - a.priority)
          .forEach(task => {
            const li = document.createElement("li");
            const lastCompletedText = task.lastCompleted
              ? `(last completed: ${formatDateDiff(task.lastCompleted)})`
              : "";
            if (!task.lastCompleted) li.classList.add("late");

            li.textContent = `${task.name} ${lastCompletedText} – Priority ${task.priority}, ${task.time} min (Scheduled: ${task.day})`;
            ul.appendChild(li);
          });

        container.appendChild(ul);
      });
    }

    // Load CSV from root folder automatically
    fetch('rooms-shifts.csv')
      .then(response => {
        if (!response.ok) throw new Error('CSV load failed');
        return response.text();
      })
      .then(handleCSV)
      .catch(error => {
        document.getElementById("results").textContent = `Error: ${error.message}`;
      });
  </script>
</body>
</html>
