<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Colerain Housekeeping Tasks</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .housekeeper { margin-bottom: 2rem; }
    .housekeeper h2 { margin-bottom: 0.5rem; }
    .task-list { margin-left: 1rem; }
    .task-done { text-decoration: line-through; color: gray; }
    .refresh-btn { margin-bottom: 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    .progress { height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-top: 5px; }
    .progress-bar { height: 10px; background: #4caf50; width: 0; transition: width 0.3s; }
  </style>
</head>
<body>
  <button class="refresh-btn" onclick="location.reload()">Refresh</button>
  <div id="content"></div>
  <div id="week-info" style="margin-top: 2rem; font-style: italic;"></div>

  <script>
    async function loadCSV(url) {
      const response = await fetch(url);
      const text = await response.text();
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
        return obj;
      });
    }

    function getCurrentWeekNumber() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const dayOffset = (firstDay.getDay() + 6) % 7; // Monday-based week
      const firstMonday = new Date(firstDay);
      firstMonday.setDate(firstDay.getDate() + (dayOffset === 0 ? 0 : 7 - dayOffset));
      const diff = today - firstMonday;
      return Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;
    }

    async function load() {
      const weekNumber = getCurrentWeekNumber();
      const schedulePath = `schedules/Colerain-Week${weekNumber}.csv`;
      const taskPath = `schedules/colerain-tasks.csv`;

      const [schedule, extraTasks] = await Promise.all([
        loadCSV(schedulePath),
        loadCSV(taskPath)
      ]);

      const content = document.getElementById('content');
      document.getElementById('week-info').textContent = `Currently showing Colerain-Week${weekNumber}.csv`;

      // Track completions using localStorage
      const completedTasks = new Set(JSON.parse(localStorage.getItem("completedColerainTasks") || "[]"));

      // Combine schedule and "Any" day tasks for this week
      const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
      const allTasks = [...extraTasks.filter(t => t.Day === 'Any' || t.Day === today), ...schedule];

      // Group by housekeeper
      const housekeepers = {};
      allTasks.forEach(task => {
        const hk = task.Housekeeper;
        if (!housekeepers[hk]) housekeepers[hk] = [];
        if (!completedTasks.has(task["Room Name"])) {
          housekeepers[hk].push(task);
        }
      });

      Object.entries(housekeepers).forEach(([hk, tasks]) => {
        const doneCount = 0; // could be calculated if needed
        const total = tasks.length;

        const section = document.createElement('div');
        section.className = 'housekeeper';
        section.innerHTML = `<h2>${hk} (${total})</h2>`;

        const list = document.createElement('ul');
        list.className = 'task-list';
        tasks.forEach(task => {
          const li = document.createElement('li');
          const link = document.createElement('a');
          link.href = task.FormLink || `https://form.jotform.com/250955404825056?space=${encodeURIComponent(task["Room Name"] || task.Room)}`;
          link.textContent = task["Room Name"] || task.Room;
          link.target = '_blank';
          li.appendChild(link);
          list.appendChild(li);
        });
        section.appendChild(list);

        const progress = document.createElement('div');
        progress.className = 'progress';
        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        bar.style.width = `${(doneCount / total) * 100}%`;
        progress.appendChild(bar);
        section.appendChild(progress);

        content.appendChild(section);
      });
    }

    load();
  </script>
</body>
</html>
