<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pending Room Assignments</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h2 { margin-top: 1em; }
    ul { margin-bottom: 2em; }
  </style>
</head>
<body>
  <h1>Pending Room Assignments</h1>
  <div id="results"></div>

  <script>
    const scheduleBasePath = "schedules/Colerain-Week";
    const tasksBasePath = "schedules/colerain-tasks";

    async function loadText(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to load ${url}`);
      return await res.text();
    }

    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split("\t");
      return lines.slice(1).map(line => {
        const values = line.split("\t");
        const entry = {};
        headers.forEach((h, i) => entry[h.trim()] = values[i]?.trim());
        return entry;
      });
    }

    function getWeekNumberForToday() {
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      const dayOffset = (first.getDay() + 6) % 7;
      const firstMonday = new Date(first);
      firstMonday.setDate(first.getDate() + (dayOffset === 0 ? 0 : 7 - dayOffset));
      const diffDays = Math.floor((now - firstMonday) / (1000 * 60 * 60 * 24));
      return Math.floor(diffDays / 7) + 1;
    }

    function getPreviousMonday(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1) - day;
      d.setDate(d.getDate() + diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getNextSunday(date = new Date()) {
      const monday = getPreviousMonday(date);
      const sunday = new Date(monday);
      sunday.setDate(sunday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return sunday;
    }

    async function loadJotformSubmissions() {
      const apiKey = "5b9a10e2092947d49dac84004ad149a2";
      const formId = "250955404825056";
      const res = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}`);
      const data = await res.json();
      const submissions = data.content || [];

      console.log("Submissions:");
      console.log(submissions);

      const validSubmissions = {};
      const prevMonday = getPreviousMonday();
      const nextSunday = getNextSunday();

      submissions.forEach((sub) => {
        const roomName = sub.answers["18"]?.answer?.trim();
        const createdAt = new Date(sub.created_at);

        console.log("Submitted room:", roomName, "on", createdAt.toISOString());

        if (!roomName || createdAt < prevMonday || createdAt > nextSunday) return;

        if (!validSubmissions[roomName] || createdAt > validSubmissions[roomName].date) {
          validSubmissions[roomName] = { date: createdAt };
        }
      });

      return validSubmissions;
    }

    async function loadAndDisplayAssignments() {
      const weekNum = getWeekNumberForToday();
      const csvText = await loadText(`${scheduleBasePath}${weekNum}.csv`);
      const assignments = parseCSV(csvText);
      const submissions = await loadJotformSubmissions();

      const personMap = {};

      assignments.forEach((item) => {
        const person = item.Housekeeper;
        const room = item["Room Name"];
        if (!submissions[room]) {
          if (!personMap[person]) personMap[person] = [];
          personMap[person].push(room);
        }
      });

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      Object.keys(personMap).sort().forEach(person => {
        const rooms = personMap[person];
        const heading = document.createElement("h2");
        heading.textContent = `${person} â€” ${rooms.length} remaining`;
        resultsDiv.appendChild(heading);

        if (rooms.length === 0) {
          const done = document.createElement("p");
          done.textContent = "See Brian for additional items.";
          resultsDiv.appendChild(done);
        } else {
          const ul = document.createElement("ul");
          rooms.forEach(room => {
            const li = document.createElement("li");
            li.textContent = room;
            ul.appendChild(li);
          });
          resultsDiv.appendChild(ul);
        }
      });
    }

    loadAndDisplayAssignments().catch(err => {
      console.error("Error:", err);
      document.getElementById("results").textContent = "Failed to load data.";
    });
  </script>
</body>
</html>
