<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Room Assignments</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      text-align: center;
    }
    .day-section {
      margin-bottom: 30px;
    }
    .housekeeper {
      margin-left: 20px;
    }
    ul {
      list-style-type: disc;
      margin-left: 40px;
    }
  </style>
</head>
<body>
  <h2>Pending Room Assignments</h2>
  <div id="schedule-container"></div>

  <script>
    const apiKey = 'YOUR_JOTFORM_API_KEY';
    const formId = 'YOUR_FORM_ID';
    const roomFieldId = '18'; // Replace with actual field ID
    const completedByFieldId = '29'; // Replace with actual field ID

    // Function to get current week's Monday and Sunday
    function getWeekBounds() {
      const now = new Date();
      const day = now.getDay();
      const diffToMonday = (day === 0) ? -6 : 1 - day;
      const monday = new Date(now);
      monday.setHours(0, 0, 0, 0);
      monday.setDate(now.getDate() + diffToMonday);

      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);

      return { monday, sunday };
    }

    // Function to parse CSV text into an array of objects
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split('\t');
      return lines.slice(1).map(line => {
        const values = line.split('\t');
        const obj = {};
        headers.forEach((header, index) => {
          obj[header.trim()] = values[index] ? values[index].trim() : '';
        });
        return obj;
      });
    }

    // Main function to load data and render the schedule
    async function loadSchedule() {
      const { monday, sunday } = getWeekBounds();

      // Fetch and parse CSV files
      const [scheduleText, assigneesText] = await Promise.all([
        fetch('Colerain - Special Schedule.csv').then(res => res.text()),
        fetch('Colerain Assignees.csv').then(res => res.text())
      ]);
      const schedule = parseCSV(scheduleText);
      const assignees = parseCSV(assigneesText);

      // Fetch submissions from Jotform
      const submissions = await fetch(`https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&limit=1000`)
        .then(res => res.json())
        .then(data => data.content || []);

      // Create a set of completed room names for the current week
      const completedRooms = new Set();
      submissions.forEach(sub => {
        const createdAt = new Date(sub.created_at);
        if (createdAt >= monday && createdAt <= sunday) {
          const room = sub.answers?.[roomFieldId]?.answer?.trim();
          if (room) {
            completedRooms.add(room);
          }
        }
      });

      // Filter out completed tasks
      const pendingTasks = schedule.filter(task => !completedRooms.has(task['Room Name']));

      // Group tasks by day and housekeeper
      const groupedTasks = {};
      pendingTasks.forEach(task => {
        const day = task['Day'];
        const housekeeper = task['Housekeeper'];
        const room = task['Room Name'];

        if (!groupedTasks[day]) {
          groupedTasks[day] = {};
        }
        if (!groupedTasks[day][housekeeper]) {
          groupedTasks[day][housekeeper] = [];
        }
        groupedTasks[day][housekeeper].push(room);
      });

      // Render the schedule
      const container = document.getElementById('schedule-container');
      container.innerHTML = '';
      Object.keys(groupedTasks).forEach(day => {
        const daySection = document.createElement('div');
        daySection.className = 'day-section';
        const dayHeader = document.createElement('h3');
        dayHeader.textContent = day;
        daySection.appendChild(dayHeader);

        Object.keys(groupedTasks[day]).forEach(housekeeper => {
          const housekeeperDiv = document.createElement('div');
          housekeeperDiv.className = 'housekeeper';
          const housekeeperHeader = document.createElement('h4');
          housekeeperHeader.textContent = `Housekeeper ${housekeeper}`;
          housekeeperDiv.appendChild(housekeeperHeader);

          const roomList = document.createElement('ul');
          groupedTasks[day][housekeeper].forEach(room => {
            const listItem = document.createElement('li');
            listItem.textContent = room;
            roomList.appendChild(listItem);
          });
          housekeeperDiv.appendChild(roomList);
          daySection.appendChild(housekeeperDiv);
        });

        container.appendChild(daySection);
      });
    }

    // Load the schedule on page load
    loadSchedule().catch(error => {
      console.error('Error loading schedule:', error);
    });
  </script>
</body>
</html>
